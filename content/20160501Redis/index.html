<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>服务器部署</title>
<BR><BR><BR>
<xmp theme="united" style="display:none;">

# Redis安装与配置

## Redis安装

```
 yum install epel-release
 yum install redis
```



配置`/etc/redis.conf`，注意其中的IP绑定配置`bind`与授权配置`requirepass`

```
#bind 127.0.0.1
requirepass xxxx
```


Redis服务安装了两台服务器，用于主备，需要安装`keepalived`服务，用于主备切换管理。

```
yum install keepalived
```


<BR>
## keeplived配置

注意：

- 一台做为`MASTER`，`priority`配置数字大100。
- 一台做为`SLAVE`，`priority`配置数字小80。

下例中的Redis服务使用了虚拟IP`192.168.0.241`，两台实体机IP是`192.168.0.215`和`192.168.0.222`，虚拟IP会在两台主备服务器进行动态切换。

```
[root@redis01 keepalived]# cat /etc/keepalived/keepalived.conf 
! Configuration File for keepalived

global_defs {
   router_id LVS_REDIS
}

vrrp_script check_redis {
    script "/etc/keepalived/scripts/redis_check.sh"
    interval 2
    weight 2
} 


vrrp_instance VI_1 {
    state MASTER
    interface ens160
    virtual_router_id 65
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass xxxxxxxxxxxxxx
    }
    virtual_ipaddress {
        192.168.0.241
    }
    track_script {
        check_redis
    }
    notify_master /etc/keepalived/scripts/redis_master.sh
    notify_backup /etc/keepalived/scripts/redis_backup.sh
    notify_fault  /etc/keepalived/scripts/redis_fault.sh
    notify_stop   /etc/keepalived/scripts/redis_stop.sh
}

[root@redis01 keepalived]# 

```

在`/etc/keepalived`目录中建立文件夹`scripts`

```
[root@redis01 keepalived]# ls -l scripts/
total 20
-rwxrwxrwx. 1 root root 448 Aug 10 14:31 redis_backup.sh
-rwxrwxrwx. 1 root root 143 Aug 10 14:31 redis_check.sh
-rwxrwxrwx. 1 root root 101 Dec 14  2016 redis_fault.sh
-rwxrwxrwx. 1 root root 595 Aug 10 14:36 redis_master.sh
-rwxrwxrwx. 1 root root 101 Aug 10 14:32 redis_stop.sh
[root@redis01 keepalived]# 

```



- `redis_backup.sh`文件内容如下，注意其中的IP地址，`两台服务器互写对方`，`xxxx`为`redis.conf`中配置的密码：

```
[root@redis01 scripts]# cat redis_backup.sh 
#!/bin/bash

REDISCLI="/usr/bin/redis-cli"
LOGFILE="/var/log/keepalived-redis-state.log"

echo "[backup]" >> $LOGFILE
date >> $LOGFILE
echo "Being slave...." >> $LOGFILE 2>&1

sleep 15
echo "Run SLAVEOF cmd ..." >> $LOGFILE
$REDISCLI -a xxxx SLAVEOF 192.168.0.222 6379 >> $LOGFILE  2>&1
echo "config password"
$REDISCLI -a xxxx config set masterauth xxxx >> $LOGFILE  2>&1


[root@redis01 scripts]# 

```



- `redis_check.sh`文件内容如下：

```
[root@redis01 scripts]# cat redis_check.sh 
#!/bin/bash

ALIVE=`/usr/bin/redis-cli -a xxxx PING`
if [ "$ALIVE" == "PONG" ]; then
  echo $ALIVE
  exit 0
else
  echo $ALIVE
  exit 1	
fi

[root@redis01 scripts]# 

```



- `redis_fault.sh`文件内容如下：

```
[root@redis01 scripts]# cat redis_fault.sh 
#!/bin/bash

LOGFILE=/var/log/keepalived-redis-state.log
echo "[fault]" >> $LOGFILE
date >> $LOGFILE
[root@redis01 scripts]# 

```



- `redis_master.sh`文件内容如下，注意其中的IP地址，`两台服务器互写对方`，`xxxx`为`redis.conf`中配置的密码：

```
[root@redis01 scripts]# cat redis_master.sh 
#!/bin/bash

REDISCLI="/usr/bin/redis-cli"
LOGFILE="/var/log/keepalived-redis-state.log"

echo "[master]" >> $LOGFILE
date >> $LOGFILE
echo "Being master...." >> $LOGFILE 2>&1

echo "Run SLAVEOF cmd ..." >> $LOGFILE
$REDISCLI -a xxxx SLAVEOF 192.168.0.222 6379 >> $LOGFILE  2>&1
echo "config password"
$REDISCLI -a xxxx config set masterauth xxxx >> $LOGFILE  2>&1

sleep 10

echo "Run SLAVEOF NO ONE cmd ..." >> $LOGFILE
$REDISCLI -a xxxx SLAVEOF NO ONE >> $LOGFILE 2>&1

echo "Redis_master execute complete " >> $LOGFILE
[root@redis01 scripts]# 

```



- `redis_stop.sh`文件内容如下：

```
[root@redis01 scripts]# cat redis_stop.sh 
#!/bin/bash

LOGFILE=/var/log/keepalived-redis-state.log
echo "[stop]" >> $LOGFILE
date >> $LOGFILE

[root@redis01 scripts]# 
```



- 使用`redis-cli`指令可以查看Redis的运行状态

```
[root@redis01 scripts]# redis-cli 
127.0.0.1:6379> auth xxxx
OK
127.0.0.1:6379> info
# Server
redis_version:3.2.3
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:672aed6eb816ad6c
redis_mode:standalone
os:Linux 3.10.0-514.el7.x86_64 x86_64
arch_bits:64
multiplexing_api:epoll
gcc_version:4.8.5
process_id:1071
run_id:142c39942122b367cd5e83c35bf7bdefcb033d21
tcp_port:6379
uptime_in_seconds:202157
uptime_in_days:2
hz:10
lru_clock:9411987
executable:/usr/bin/redis-server
config_file:/etc/redis.conf

# Clients
connected_clients:1
client_longest_output_list:0
client_biggest_input_buf:0
blocked_clients:0

# Memory
used_memory:2069464
used_memory_human:1.97M
used_memory_rss:8204288
used_memory_rss_human:7.82M
used_memory_peak:2213240
used_memory_peak_human:2.11M
total_system_memory:8203354112
total_system_memory_human:7.64G
used_memory_lua:37888
used_memory_lua_human:37.00K
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
mem_fragmentation_ratio:3.96
mem_allocator:jemalloc-3.6.0

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1502509744
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:0
rdb_current_bgsave_time_sec:-1
aof_enabled:1
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:0
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_current_size:3500688
aof_base_size:156183
aof_pending_rewrite:0
aof_buffer_length:0
aof_rewrite_buffer_length:0
aof_pending_bio_fsync:0
aof_delayed_fsync:0

# Stats
total_connections_received:115420
total_commands_processed:588865
instantaneous_ops_per_sec:2
total_net_input_bytes:19163621
total_net_output_bytes:683245871208
instantaneous_input_kbps:0.06
instantaneous_output_kbps:3614.52
rejected_connections:0
sync_full:2
sync_partial_ok:0
sync_partial_err:0
expired_keys:14
evicted_keys:0
keyspace_hits:1312
keyspace_misses:24
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:1167
migrate_cached_sockets:0

# Replication
role:master
connected_slaves:1
slave0:ip=192.168.0.222,port=6379,state=online,offset=3666199,lag=1
master_repl_offset:3666199
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2617624
repl_backlog_histlen:1048576

# CPU
used_cpu_sys:817.27
used_cpu_user:176.04
used_cpu_sys_children:0.12
used_cpu_user_children:0.06

# Cluster
cluster_enabled:0

# Keyspace
db0:keys=472,expires=0,avg_ttl=0
127.0.0.1:6379> exit
[root@redis01 scripts]# 

```





Redis需要使用6379端口，keepalived服务需要打开组播，在防火墙中添加配置

```
firewall-cmd --permanent --zone=public --add-port=6379/tcp
firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT

firewall-cmd --reload
firewall-cmd --list-all
```



重启服务

```
systemctl enable redis
systemctl enable keepalived
systemctl restart redis
systemctl restart keepalived
```


</xmp>

<script src="../../strapdown/strapdown.js"></script>
</html>
